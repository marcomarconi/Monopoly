# continuons positions
# m_pred <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% matrix(nrow=2000); m_pred <- head(m_pred, length(y))
# p <- (lead(m_pred) - y) %>% apply(., 2, function(x) table(x>0)/length(x))
# p <- p[1,] - p[2,]
# df <- data.frame(Date=d, y=y, trade = p )
df$ret1 <- c(0, diff(log(x1)))
df$ret2 <-  c(0, diff(log(x2)))
df$pnl <- 0.5 * lag(df$trade) * (df$ret1 - df$ret2)
df$pnl[is.na(df$pnl)] <- 0
plot(cumsum(df$pnl))
colors <- df$pnl; colors[colors>0] <- "blue"; colors[colors<0] <- "red"
plot(df$Date, df$y %>% scale, pch=16, type="o", col=colors, cex=2); lines(df$Date, df$y %>% scale); abline(v=seq(df$Date[1], df$Date[nrow(df)] , by=365), lty=2)
print(mean(df$pnl) / sd(df$pnl) * sqrt(12))
plot.ts(SMA(df$pnl^2,3))
get_returns_statistics(data.frame(df$pnl), period = 12) %>% unlist
}
df_1_2 <- df$pnl
# Execute backtest univariate
{
df <- Oil_extended
y <- df$GasolineSpread %>% na.omit
x1 <- tail(df$Gasoline, length(y))
x2 <- tail(df$Brent, length(y))
d <- tail(df$Date, length(y))
fit <- fit_m3.0_gasoline
factor <- 10
par(mfrow=c(3,1), mar=c(2,2,1,0.5))
# discrete positions
m_pred <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred <- head(m_pred, length(y))
P_pred <-  fit$draws(variables = "P_pred")  %>% merge_chains %>% colMeans() %>% as.vector; P_pred <- sqrt(head(P_pred, length(y)))
S <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S <- sqrt(head(S, length(y)))
df <- data.frame(Date=d, y=y, m=lead(m_pred), l=lead(m_pred-P_pred/factor), h=lead(m_pred+P_pred/factor))
df$trade <- (with(df, ifelse(l>y & h>y, 1, ifelse(l<y & h<y, -1, 0)))) * 1 / S^2;
# continuons positions
# m_pred <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% matrix(nrow=2000); m_pred <- head(m_pred, length(y))
# p <- (lead(m_pred) - y) %>% apply(., 2, function(x) table(x>0)/length(x))
# p <- p[1,] - p[2,]
# df <- data.frame(Date=d, y=y, trade = p )
df$ret1 <- c(0, diff(log(x1)))
df$ret2 <-  c(0, diff(log(x2)))
df$pnl <- 0.5 * lag(df$trade) * (df$ret1 - df$ret2)
df$pnl[is.na(df$pnl)] <- 0
plot(cumsum(df$pnl))
colors <- df$pnl; colors[colors>0] <- "blue"; colors[colors<0] <- "red"
plot(df$Date, df$y %>% scale, pch=16, type="o", col=colors, cex=2); lines(df$Date, df$y %>% scale); abline(v=seq(df$Date[1], df$Date[nrow(df)] , by=365), lty=2)
print(mean(df$pnl) / sd(df$pnl) * sqrt(12))
plot.ts(SMA(df$pnl^2,3))
get_returns_statistics(data.frame(df$pnl), period = 12) %>% unlist
}
df_1_2 <- df$pnl
df_1_1 <- df$pnl
# Execute backtest univariate
{
df <- Oil_extended
y <- df$HoSpread %>% na.omit
x1 <- tail(df$HeatingOil, length(y))
x2 <- tail(df$Brent, length(y))
d <- tail(df$Date, length(y))
fit <- fit_m3.0_heatingoil
factor <- 10
par(mfrow=c(3,1), mar=c(2,2,1,0.5))
# discrete positions
m_pred <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred <- head(m_pred, length(y))
P_pred <-  fit$draws(variables = "P_pred")  %>% merge_chains %>% colMeans() %>% as.vector; P_pred <- sqrt(head(P_pred, length(y)))
S <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S <- sqrt(head(S, length(y)))
df <- data.frame(Date=d, y=y, m=lead(m_pred), l=lead(m_pred-P_pred/factor), h=lead(m_pred+P_pred/factor))
df$trade <- (with(df, ifelse(l>y & h>y, 1, ifelse(l<y & h<y, -1, 0)))) * 1 / S^2;
# continuons positions
# m_pred <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% matrix(nrow=2000); m_pred <- head(m_pred, length(y))
# p <- (lead(m_pred) - y) %>% apply(., 2, function(x) table(x>0)/length(x))
# p <- p[1,] - p[2,]
# df <- data.frame(Date=d, y=y, trade = p )
df$ret1 <- c(0, diff(log(x1)))
df$ret2 <-  c(0, diff(log(x2)))
df$pnl <- 0.5 * lag(df$trade) * (df$ret1 - df$ret2)
df$pnl[is.na(df$pnl)] <- 0
plot(cumsum(df$pnl))
colors <- df$pnl; colors[colors>0] <- "blue"; colors[colors<0] <- "red"
plot(df$Date, df$y %>% scale, pch=16, type="o", col=colors, cex=2); lines(df$Date, df$y %>% scale); abline(v=seq(df$Date[1], df$Date[nrow(df)] , by=365), lty=2)
print(mean(df$pnl) / sd(df$pnl) * sqrt(12))
plot.ts(SMA(df$pnl^2,3))
get_returns_statistics(data.frame(df$pnl), period = 12) %>% unlist
}
df_1_2 <- df$pnl
get_returns_statistics(data.frame(df_1_1, df_1_2), period = 12) %>% unlist
fit <- fit_m4.0
m_pred <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred <- head(m_pred, length(y))
m_pred
m_pred <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector();
m_pred
# Execute backtest univariate
{
df <- Oil_extended
y <- cbind(df$GasolineSpread, df$HoSpread) %>% na.omit
x1_1 <- tail(df$HeatingOil, length(y))
x1_2 <- tail(df$GasolineSpread, length(y))
x2 <- tail(df$Brent, length(y))
d <- tail(df$Date, length(y))
fit <- fit_m4.0
par(mfrow=c(3,1), mar=c(2,2,1,0.5))
m_pred_1 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred <- head(m_pred, length(y))
m_pred_2 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred <- tail(m_pred, length(y))
S_1 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S <- sqrt(head(S, length(y)))
S_2 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S <- sqrt(tail(S, length(y)))
df <- data.frame(Date=d, y_1=y[,1], y_2=y[,2], m_1=lead(m_pred_1), m_2=lead(m_pred_2))
df$trade_1 <- (with(df, ifelse(m_1>y_1, 1, ifelse(m_1<y_1, -1, 0)))) * 1 / S_1^2;
df$trade_2 <- (with(df, ifelse(m_2>y_2, 1, ifelse(m_2<y_2, -1, 0)))) * 1 / S_2^2;
df$ret1_1 <- c(0, diff(log(x1_1)))
df$ret1_2 <-  c(0, diff(log(x1_2)))
df$ret2 <-  c(0, diff(log(x2)))
df$pnl_1 <- 0.25 * lag(df$trade_1) * (df$ret1_1 - df$ret2)
df$pnl_2 <- 0.25 * lag(df$trade_2) * (df$ret1_2 - df$ret2)
df$pnl_1[is.na(df$pnl_1)] <- 0
df$pnl_2[is.na(df$pnl_2)] <- 0
df$pnl <- df$pnl_1 + df$pnl_2
plot(cumsum(df$pnl))
#colors <- df$pnl; colors[colors>0] <- "blue"; colors[colors<0] <- "red"
#plot(df$Date, df$y %>% scale, pch=16, type="o", col=colors, cex=2); lines(df$Date, df$y %>% scale); abline(v=seq(df$Date[1], df$Date[nrow(df)] , by=365), lty=2)
#print(mean(df$pnl) / sd(df$pnl) * sqrt(12))
#plot.ts(SMA(df$pnl^2,3))
get_returns_statistics(data.frame(df$pnl), period = 12) %>% unlist
}
df <- Oil_extended
y <- cbind(df$GasolineSpread, df$HoSpread) %>% na.omit
x1_1 <- tail(df$HeatingOil, length(y))
x1_2 <- tail(df$GasolineSpread, length(y))
x2 <- tail(df$Brent, length(y))
d <- tail(df$Date, length(y))
fit <- fit_m4.0
par(mfrow=c(3,1), mar=c(2,2,1,0.5))
m_pred_1 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred <- head(m_pred, length(y))
m_pred_2 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred <- tail(m_pred, length(y))
S_1 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S <- sqrt(head(S, length(y)))
S_2 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S <- sqrt(tail(S, length(y)))
df <- data.frame(Date=d, y_1=y[,1], y_2=y[,2], m_1=lead(m_pred_1), m_2=lead(m_pred_2))
# Execute backtest univariate
{
df <- Oil_extended
y <- cbind(df$GasolineSpread, df$HoSpread) %>% na.omit
x1_1 <- tail(df$HeatingOil, length(y))
x1_2 <- tail(df$GasolineSpread, length(y))
x2 <- tail(df$Brent, length(y))
d <- tail(df$Date, length(y))
fit <- fit_m4.0
par(mfrow=c(3,1), mar=c(2,2,1,0.5))
m_pred_1 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred_1 <- head(m_pred_1, length(y))
m_pred_2 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred_2 <- tail(m_pred_2, length(y))
S_1 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S <- sqrt(head(S, length(y)))
S_2 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S <- sqrt(tail(S, length(y)))
df <- data.frame(Date=d, y_1=y[,1], y_2=y[,2], m_1=lead(m_pred_1), m_2=lead(m_pred_2))
df$trade_1 <- (with(df, ifelse(m_1>y_1, 1, ifelse(m_1<y_1, -1, 0)))) * 1 / S_1^2;
df$trade_2 <- (with(df, ifelse(m_2>y_2, 1, ifelse(m_2<y_2, -1, 0)))) * 1 / S_2^2;
df$ret1_1 <- c(0, diff(log(x1_1)))
df$ret1_2 <-  c(0, diff(log(x1_2)))
df$ret2 <-  c(0, diff(log(x2)))
df$pnl_1 <- 0.25 * lag(df$trade_1) * (df$ret1_1 - df$ret2)
df$pnl_2 <- 0.25 * lag(df$trade_2) * (df$ret1_2 - df$ret2)
df$pnl_1[is.na(df$pnl_1)] <- 0
df$pnl_2[is.na(df$pnl_2)] <- 0
df$pnl <- df$pnl_1 + df$pnl_2
plot(cumsum(df$pnl))
#colors <- df$pnl; colors[colors>0] <- "blue"; colors[colors<0] <- "red"
#plot(df$Date, df$y %>% scale, pch=16, type="o", col=colors, cex=2); lines(df$Date, df$y %>% scale); abline(v=seq(df$Date[1], df$Date[nrow(df)] , by=365), lty=2)
#print(mean(df$pnl) / sd(df$pnl) * sqrt(12))
#plot.ts(SMA(df$pnl^2,3))
get_returns_statistics(data.frame(df$pnl), period = 12) %>% unlist
}
m_pred_1
# Execute backtest univariate
{
df <- Oil_extended
y <- cbind(df$GasolineSpread, df$HoSpread) %>% na.omit
x1_1 <- tail(df$HeatingOil, length(y))
x1_2 <- tail(df$GasolineSpread, length(y))
x2 <- tail(df$Brent, length(y))
d <- tail(df$Date, length(y))
fit <- fit_m4.0
par(mfrow=c(3,1), mar=c(2,2,1,0.5))
m_pred_1 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred_1 <- head(m_pred_1, nrow(y))
m_pred_2 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred_2 <- tail(m_pred_2, nrow(y))
S_1 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S <- sqrt(head(S, length(y)))
S_2 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S <- sqrt(tail(S, length(y)))
df <- data.frame(Date=d, y_1=y[,1], y_2=y[,2], m_1=lead(m_pred_1), m_2=lead(m_pred_2))
df$trade_1 <- (with(df, ifelse(m_1>y_1, 1, ifelse(m_1<y_1, -1, 0)))) * 1 / S_1^2;
df$trade_2 <- (with(df, ifelse(m_2>y_2, 1, ifelse(m_2<y_2, -1, 0)))) * 1 / S_2^2;
df$ret1_1 <- c(0, diff(log(x1_1)))
df$ret1_2 <-  c(0, diff(log(x1_2)))
df$ret2 <-  c(0, diff(log(x2)))
df$pnl_1 <- 0.25 * lag(df$trade_1) * (df$ret1_1 - df$ret2)
df$pnl_2 <- 0.25 * lag(df$trade_2) * (df$ret1_2 - df$ret2)
df$pnl_1[is.na(df$pnl_1)] <- 0
df$pnl_2[is.na(df$pnl_2)] <- 0
df$pnl <- df$pnl_1 + df$pnl_2
plot(cumsum(df$pnl))
#colors <- df$pnl; colors[colors>0] <- "blue"; colors[colors<0] <- "red"
#plot(df$Date, df$y %>% scale, pch=16, type="o", col=colors, cex=2); lines(df$Date, df$y %>% scale); abline(v=seq(df$Date[1], df$Date[nrow(df)] , by=365), lty=2)
#print(mean(df$pnl) / sd(df$pnl) * sqrt(12))
#plot.ts(SMA(df$pnl^2,3))
get_returns_statistics(data.frame(df$pnl), period = 12) %>% unlist
}
m_pred_1
m_pred_2
y_2
x1_2 <- tail(df$GasolineSpread, length(y))
x2 <- tail(df$Brent, length(y))
d <- tail(df$Date, length(y))
m_pred_1 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred_1 <- head(m_pred_1, nrow(y))
m_pred_2 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred_2 <- tail(m_pred_2, nrow(y))
S_1 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S <- sqrt(head(S, length(y)))
S_2 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S <- sqrt(tail(S, length(y)))
df <- data.frame(Date=d, y_1=y[,1], y_2=y[,2], m_1=lead(m_pred_1), m_2=lead(m_pred_2))
d
# Execute backtest univariate
{
df <- Oil_extended
y <- cbind(df$GasolineSpread, df$HoSpread) %>% na.omit
x1_1 <- tail(df$HeatingOil, nrow(y))
x1_2 <- tail(df$GasolineSpread, nrow(y))
x2 <- tail(df$Brent, nrow(y))
d <- tail(df$Date, nrow(y))
fit <- fit_m4.0
par(mfrow=c(3,1), mar=c(2,2,1,0.5))
m_pred_1 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred_1 <- head(m_pred_1, nrow(y))
m_pred_2 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred_2 <- tail(m_pred_2, nrow(y))
S_1 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S <- sqrt(head(S, length(y)))
S_2 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S <- sqrt(tail(S, length(y)))
df <- data.frame(Date=d, y_1=y[,1], y_2=y[,2], m_1=lead(m_pred_1), m_2=lead(m_pred_2))
df$trade_1 <- (with(df, ifelse(m_1>y_1, 1, ifelse(m_1<y_1, -1, 0)))) * 1 / S_1^2;
df$trade_2 <- (with(df, ifelse(m_2>y_2, 1, ifelse(m_2<y_2, -1, 0)))) * 1 / S_2^2;
df$ret1_1 <- c(0, diff(log(x1_1)))
df$ret1_2 <-  c(0, diff(log(x1_2)))
df$ret2 <-  c(0, diff(log(x2)))
df$pnl_1 <- 0.25 * lag(df$trade_1) * (df$ret1_1 - df$ret2)
df$pnl_2 <- 0.25 * lag(df$trade_2) * (df$ret1_2 - df$ret2)
df$pnl_1[is.na(df$pnl_1)] <- 0
df$pnl_2[is.na(df$pnl_2)] <- 0
df$pnl <- df$pnl_1 + df$pnl_2
plot(cumsum(df$pnl))
#colors <- df$pnl; colors[colors>0] <- "blue"; colors[colors<0] <- "red"
#plot(df$Date, df$y %>% scale, pch=16, type="o", col=colors, cex=2); lines(df$Date, df$y %>% scale); abline(v=seq(df$Date[1], df$Date[nrow(df)] , by=365), lty=2)
#print(mean(df$pnl) / sd(df$pnl) * sqrt(12))
#plot.ts(SMA(df$pnl^2,3))
get_returns_statistics(data.frame(df$pnl), period = 12) %>% unlist
}
df <- Oil_extended
y <- cbind(df$GasolineSpread, df$HoSpread) %>% na.omit
x1_1 <- tail(df$HeatingOil, nrow(y))
x1_2 <- tail(df$GasolineSpread, nrow(y))
x2 <- tail(df$Brent, nrow(y))
d <- tail(df$Date, nrow(y))
fit <- fit_m4.0
y
x1_1
x1_2
x2
d
df <- Oil_extended
y <- cbind(df$GasolineSpread, df$HoSpread) %>% na.omit
x1_1 <- tail(df$HeatingOil, nrow(y))
x1_2 <- tail(df$GasolineSpread, nrow(y))
x2 <- tail(df$Brent, nrow(y))
d <- tail(df$Date, nrow(y))
fit <- fit_m4.0
par(mfrow=c(3,1), mar=c(2,2,1,0.5))
m_pred_1 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred_1 <- head(m_pred_1, nrow(y))
m_pred_2 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred_2 <- tail(m_pred_2, nrow(y))
m_pred_1
m_pred_2
S_1
# Execute backtest univariate
{
df <- Oil_extended
y <- cbind(df$GasolineSpread, df$HoSpread) %>% na.omit
x1_1 <- tail(df$HeatingOil, nrow(y))
x1_2 <- tail(df$GasolineSpread, nrow(y))
x2 <- tail(df$Brent, nrow(y))
d <- tail(df$Date, nrow(y))
fit <- fit_m4.0
par(mfrow=c(3,1), mar=c(2,2,1,0.5))
m_pred_1 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred_1 <- head(m_pred_1, nrow(y))
m_pred_2 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred_2 <- tail(m_pred_2, nrow(y))
S_1 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S <- sqrt(head(S, nrow(y)))
S_2 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S <- sqrt(tail(S, nrow(y)))
df <- data.frame(Date=d, y_1=y[,1], y_2=y[,2], m_1=lead(m_pred_1), m_2=lead(m_pred_2))
df$trade_1 <- (with(df, ifelse(m_1>y_1, 1, ifelse(m_1<y_1, -1, 0)))) * 1 / S_1^2;
df$trade_2 <- (with(df, ifelse(m_2>y_2, 1, ifelse(m_2<y_2, -1, 0)))) * 1 / S_2^2;
df$ret1_1 <- c(0, diff(log(x1_1)))
df$ret1_2 <-  c(0, diff(log(x1_2)))
df$ret2 <-  c(0, diff(log(x2)))
df$pnl_1 <- 0.25 * lag(df$trade_1) * (df$ret1_1 - df$ret2)
df$pnl_2 <- 0.25 * lag(df$trade_2) * (df$ret1_2 - df$ret2)
df$pnl_1[is.na(df$pnl_1)] <- 0
df$pnl_2[is.na(df$pnl_2)] <- 0
df$pnl <- df$pnl_1 + df$pnl_2
plot(cumsum(df$pnl))
#colors <- df$pnl; colors[colors>0] <- "blue"; colors[colors<0] <- "red"
#plot(df$Date, df$y %>% scale, pch=16, type="o", col=colors, cex=2); lines(df$Date, df$y %>% scale); abline(v=seq(df$Date[1], df$Date[nrow(df)] , by=365), lty=2)
#print(mean(df$pnl) / sd(df$pnl) * sqrt(12))
#plot.ts(SMA(df$pnl^2,3))
get_returns_statistics(data.frame(df$pnl), period = 12) %>% unlist
}
df <- data.frame(Date=d, y_1=y[,1], y_2=y[,2], m_1=lead(m_pred_1), m_2=lead(m_pred_2))
df$trade_1 <- (with(df, ifelse(m_1>y_1, 1, ifelse(m_1<y_1, -1, 0)))) * 1 / S_1^2;
df
S_1
df$trade_1 <- (with(df, ifelse(m_1>y_1, 1, ifelse(m_1<y_1, -1, 0)))) * 1 / S_1^2;
# Execute backtest univariate
{
df <- Oil_extended
y <- cbind(df$GasolineSpread, df$HoSpread) %>% na.omit
x1_1 <- tail(df$HeatingOil, nrow(y))
x1_2 <- tail(df$GasolineSpread, nrow(y))
x2 <- tail(df$Brent, nrow(y))
d <- tail(df$Date, nrow(y))
fit <- fit_m4.0
par(mfrow=c(3,1), mar=c(2,2,1,0.5))
m_pred_1 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred_1 <- head(m_pred_1, nrow(y))
m_pred_2 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred_2 <- tail(m_pred_2, nrow(y))
S_1 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S_1 <- sqrt(head(S_1, nrow(y)))
S_2 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S_2 <- sqrt(tail(S_2, nrow(y)))
df <- data.frame(Date=d, y_1=y[,1], y_2=y[,2], m_1=lead(m_pred_1), m_2=lead(m_pred_2))
df$trade_1 <- (with(df, ifelse(m_1>y_1, 1, ifelse(m_1<y_1, -1, 0)))) * 1 / S_1^2;
df$trade_2 <- (with(df, ifelse(m_2>y_2, 1, ifelse(m_2<y_2, -1, 0)))) * 1 / S_2^2;
df$ret1_1 <- c(0, diff(log(x1_1)))
df$ret1_2 <-  c(0, diff(log(x1_2)))
df$ret2 <-  c(0, diff(log(x2)))
df$pnl_1 <- 0.25 * lag(df$trade_1) * (df$ret1_1 - df$ret2)
df$pnl_2 <- 0.25 * lag(df$trade_2) * (df$ret1_2 - df$ret2)
df$pnl_1[is.na(df$pnl_1)] <- 0
df$pnl_2[is.na(df$pnl_2)] <- 0
df$pnl <- df$pnl_1 + df$pnl_2
plot(cumsum(df$pnl))
#colors <- df$pnl; colors[colors>0] <- "blue"; colors[colors<0] <- "red"
#plot(df$Date, df$y %>% scale, pch=16, type="o", col=colors, cex=2); lines(df$Date, df$y %>% scale); abline(v=seq(df$Date[1], df$Date[nrow(df)] , by=365), lty=2)
#print(mean(df$pnl) / sd(df$pnl) * sqrt(12))
#plot.ts(SMA(df$pnl^2,3))
get_returns_statistics(data.frame(df$pnl), period = 12) %>% unlist
}
# Execute backtest univariate
{
df <- Oil_extended
y <- cbind(df$GasolineSpread, df$HoSpread) %>% na.omit
x1_1 <- tail(df$HeatingOil, nrow(y))
x1_2 <- tail(df$GasolineSpread, nrow(y))
x2 <- tail(df$Brent, nrow(y))
d <- tail(df$Date, nrow(y))
fit <- fit_m4.0
par(mfrow=c(3,1), mar=c(2,2,1,0.5))
m_pred_1 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred_1 <- head(m_pred_1, nrow(y))
m_pred_2 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred_2 <- tail(m_pred_2, nrow(y))
S_1 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S_1 <- sqrt(head(S_1, nrow(y)))
S_2 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S_2 <- sqrt(tail(S_2, nrow(y)))
df <- data.frame(Date=d, y_1=y[,1], y_2=y[,2], m_1=lead(m_pred_1), m_2=lead(m_pred_2))
df$trade_1 <- (with(df, ifelse(m_1>y_1, 1, ifelse(m_1<y_1, -1, 0))))# * 1 / S_1^2;
df$trade_2 <- (with(df, ifelse(m_2>y_2, 1, ifelse(m_2<y_2, -1, 0))))# * 1 / S_2^2;
df$ret1_1 <- c(0, diff(log(x1_1)))
df$ret1_2 <-  c(0, diff(log(x1_2)))
df$ret2 <-  c(0, diff(log(x2)))
df$pnl_1 <- 0.25 * lag(df$trade_1) * (df$ret1_1 - df$ret2)
df$pnl_2 <- 0.25 * lag(df$trade_2) * (df$ret1_2 - df$ret2)
df$pnl_1[is.na(df$pnl_1)] <- 0
df$pnl_2[is.na(df$pnl_2)] <- 0
df$pnl <- df$pnl_1 + df$pnl_2
plot(cumsum(df$pnl))
#colors <- df$pnl; colors[colors>0] <- "blue"; colors[colors<0] <- "red"
#plot(df$Date, df$y %>% scale, pch=16, type="o", col=colors, cex=2); lines(df$Date, df$y %>% scale); abline(v=seq(df$Date[1], df$Date[nrow(df)] , by=365), lty=2)
#print(mean(df$pnl) / sd(df$pnl) * sqrt(12))
#plot.ts(SMA(df$pnl^2,3))
get_returns_statistics(data.frame(df$pnl), period = 12) %>% unlist
}
x1_1 %>% plot.ts
x1_2 %>% plot.ts
# Execute backtest univariate
{
df <- Oil_extended
y <- cbind(df$GasolineSpread, df$HoSpread) %>% na.omit
x1_1 <- tail(df$Gasoline, nrow(y))
x1_2 <- tail(df$HeatingOil, nrow(y))
x2 <- tail(df$Brent, nrow(y))
d <- tail(df$Date, nrow(y))
fit <- fit_m4.0
par(mfrow=c(3,1), mar=c(2,2,1,0.5))
m_pred_1 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred_1 <- head(m_pred_1, nrow(y))
m_pred_2 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred_2 <- tail(m_pred_2, nrow(y))
S_1 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S_1 <- sqrt(head(S_1, nrow(y)))
S_2 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S_2 <- sqrt(tail(S_2, nrow(y)))
df <- data.frame(Date=d, y_1=y[,1], y_2=y[,2], m_1=lead(m_pred_1), m_2=lead(m_pred_2))
df$trade_1 <- (with(df, ifelse(m_1>y_1, 1, ifelse(m_1<y_1, -1, 0))))# * 1 / S_1^2;
df$trade_2 <- (with(df, ifelse(m_2>y_2, 1, ifelse(m_2<y_2, -1, 0))))# * 1 / S_2^2;
df$ret1_1 <- c(0, diff(log(x1_1)))
df$ret1_2 <-  c(0, diff(log(x1_2)))
df$ret2 <-  c(0, diff(log(x2)))
df$pnl_1 <- 0.25 * lag(df$trade_1) * (df$ret1_1 - df$ret2)
df$pnl_2 <- 0.25 * lag(df$trade_2) * (df$ret1_2 - df$ret2)
df$pnl_1[is.na(df$pnl_1)] <- 0
df$pnl_2[is.na(df$pnl_2)] <- 0
df$pnl <- df$pnl_1 + df$pnl_2
plot(cumsum(df$pnl))
#colors <- df$pnl; colors[colors>0] <- "blue"; colors[colors<0] <- "red"
#plot(df$Date, df$y %>% scale, pch=16, type="o", col=colors, cex=2); lines(df$Date, df$y %>% scale); abline(v=seq(df$Date[1], df$Date[nrow(df)] , by=365), lty=2)
#print(mean(df$pnl) / sd(df$pnl) * sqrt(12))
#plot.ts(SMA(df$pnl^2,3))
get_returns_statistics(data.frame(df$pnl), period = 12) %>% unlist
}
get_returns_statistics(data.frame(df_1_1, df_1_2), period = 12) %>% unlist
# Execute backtest univariate
{
df <- Oil_extended
y <- cbind(df$GasolineSpread, df$HoSpread) %>% na.omit
x1_1 <- tail(df$Gasoline, nrow(y))
x1_2 <- tail(df$HeatingOil, nrow(y))
x2 <- tail(df$Brent, nrow(y))
d <- tail(df$Date, nrow(y))
fit <- fit_m4.0
par(mfrow=c(3,1), mar=c(2,2,1,0.5))
m_pred_1 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred_1 <- head(m_pred_1, nrow(y))
m_pred_2 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred_2 <- tail(m_pred_2, nrow(y))
S_1 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S_1 <- sqrt(head(S_1, nrow(y)))
S_2 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S_2 <- sqrt(tail(S_2, nrow(y)))
df <- data.frame(Date=d, y_1=y[,1], y_2=y[,2], m_1=lead(m_pred_1), m_2=lead(m_pred_2))
df$trade_1 <- (with(df, ifelse(m_1>y_1, 1, ifelse(m_1<y_1, -1, 0)))) * 1 / S_1^2;
df$trade_2 <- (with(df, ifelse(m_2>y_2, 1, ifelse(m_2<y_2, -1, 0)))) * 1 / S_2^2;
df$ret1_1 <- c(0, diff(log(x1_1)))
df$ret1_2 <-  c(0, diff(log(x1_2)))
df$ret2 <-  c(0, diff(log(x2)))
df$pnl_1 <- 0.25 * lag(df$trade_1) * (df$ret1_1 - df$ret2)
df$pnl_2 <- 0.25 * lag(df$trade_2) * (df$ret1_2 - df$ret2)
df$pnl_1[is.na(df$pnl_1)] <- 0
df$pnl_2[is.na(df$pnl_2)] <- 0
df$pnl <- df$pnl_1 + df$pnl_2
plot(cumsum(df$pnl))
#colors <- df$pnl; colors[colors>0] <- "blue"; colors[colors<0] <- "red"
#plot(df$Date, df$y %>% scale, pch=16, type="o", col=colors, cex=2); lines(df$Date, df$y %>% scale); abline(v=seq(df$Date[1], df$Date[nrow(df)] , by=365), lty=2)
#print(mean(df$pnl) / sd(df$pnl) * sqrt(12))
#plot.ts(SMA(df$pnl^2,3))
get_returns_statistics(data.frame(df$pnl), period = 12) %>% unlist
}
# Execute backtest univariate
{
df <- Oil_extended
y <- cbind(df$GasolineSpread, df$HoSpread) %>% na.omit
x1_1 <- tail(df$Gasoline, nrow(y))
x1_2 <- tail(df$HeatingOil, nrow(y))
x2 <- tail(df$Brent, nrow(y))
d <- tail(df$Date, nrow(y))
fit <- fit_m4.0
par(mfrow=c(3,1), mar=c(2,2,1,0.5))
m_pred_1 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred_1 <- head(m_pred_1, nrow(y))
m_pred_2 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred_2 <- tail(m_pred_2, nrow(y))
S_1 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S_1 <- sqrt(head(S_1, nrow(y)))
S_2 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S_2 <- sqrt(tail(S_2, nrow(y)))
df <- data.frame(Date=d, y_1=y[,1], y_2=y[,2], m_1=lead(m_pred_1), m_2=lead(m_pred_2))
df$trade_1 <- (with(df, ifelse(m_1>y_1, 1, ifelse(m_1<y_1, -1, 0)))) * 1 / S_1;
df$trade_2 <- (with(df, ifelse(m_2>y_2, 1, ifelse(m_2<y_2, -1, 0)))) * 1 / S_2;
df$ret1_1 <- c(0, diff(log(x1_1)))
df$ret1_2 <-  c(0, diff(log(x1_2)))
df$ret2 <-  c(0, diff(log(x2)))
df$pnl_1 <- 0.25 * lag(df$trade_1) * (df$ret1_1 - df$ret2)
df$pnl_2 <- 0.25 * lag(df$trade_2) * (df$ret1_2 - df$ret2)
df$pnl_1[is.na(df$pnl_1)] <- 0
df$pnl_2[is.na(df$pnl_2)] <- 0
df$pnl <- df$pnl_1 + df$pnl_2
plot(cumsum(df$pnl))
#colors <- df$pnl; colors[colors>0] <- "blue"; colors[colors<0] <- "red"
#plot(df$Date, df$y %>% scale, pch=16, type="o", col=colors, cex=2); lines(df$Date, df$y %>% scale); abline(v=seq(df$Date[1], df$Date[nrow(df)] , by=365), lty=2)
#print(mean(df$pnl) / sd(df$pnl) * sqrt(12))
#plot.ts(SMA(df$pnl^2,3))
get_returns_statistics(data.frame(df$pnl), period = 12) %>% unlist
}
# Execute backtest univariate
{
df <- Oil_extended
y <- cbind(df$GasolineSpread, df$HoSpread) %>% na.omit
x1_1 <- tail(df$Gasoline, nrow(y))
x1_2 <- tail(df$HeatingOil, nrow(y))
x2 <- tail(df$Brent, nrow(y))
d <- tail(df$Date, nrow(y))
fit <- fit_m4.0
par(mfrow=c(3,1), mar=c(2,2,1,0.5))
m_pred_1 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred_1 <- head(m_pred_1, nrow(y))
m_pred_2 <-  fit$draws(variables = "m_pred")  %>% merge_chains %>% colMeans() %>% as.vector(); m_pred_2 <- tail(m_pred_2, nrow(y))
S_1 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S_1 <- sqrt(head(S_1, nrow(y)))
S_2 <-  fit$draws(variables = "S")  %>% merge_chains %>% colMeans() %>% as.vector; S_2 <- sqrt(tail(S_2, nrow(y)))
df <- data.frame(Date=d, y_1=y[,1], y_2=y[,2], m_1=lead(m_pred_1), m_2=lead(m_pred_2))
df$trade_1 <- (with(df, ifelse(m_1>y_1, 1, ifelse(m_1<y_1, -1, 0)))) #* 1 / S_1;
df$trade_2 <- (with(df, ifelse(m_2>y_2, 1, ifelse(m_2<y_2, -1, 0)))) #* 1 / S_2;
df$ret1_1 <- c(0, diff(log(x1_1)))
df$ret1_2 <-  c(0, diff(log(x1_2)))
df$ret2 <-  c(0, diff(log(x2)))
df$pnl_1 <- 0.25 * lag(df$trade_1) * (df$ret1_1 - df$ret2)
df$pnl_2 <- 0.25 * lag(df$trade_2) * (df$ret1_2 - df$ret2)
df$pnl_1[is.na(df$pnl_1)] <- 0
df$pnl_2[is.na(df$pnl_2)] <- 0
df$pnl <- df$pnl_1 + df$pnl_2
plot(cumsum(df$pnl))
#colors <- df$pnl; colors[colors>0] <- "blue"; colors[colors<0] <- "red"
#plot(df$Date, df$y %>% scale, pch=16, type="o", col=colors, cex=2); lines(df$Date, df$y %>% scale); abline(v=seq(df$Date[1], df$Date[nrow(df)] , by=365), lty=2)
#print(mean(df$pnl) / sd(df$pnl) * sqrt(12))
#plot.ts(SMA(df$pnl^2,3))
get_returns_statistics(data.frame(df$pnl), period = 12) %>% unlist
}
get_returns_statistics(data.frame(df_1_1, df_1_2), period = 12) %>% unlist
get_returns_statistics(data.frame(df_1_1), period = 12) %>% unlist
get_returns_statistics(data.frame(df_1_2), period = 12) %>% unlist
get_returns_statistics(data.frame(df_1_1, df_1_2), period = 12, plot=T) %>% unlist
get_returns_statistics(data.frame(df$pnl), period = 12, plot=T) %>% unlist
get_returns_statistics(data.frame(df$pnl_1, df$pnl_2), period = 12, plot=T) %>% unlist
df$pnl_1 %>% hist
df$1_1 %>% hist
df_1_1 %>% hist
get_returns_statistics(data.frame(df_1_1, df_1_2)*2, period = 12, plot=T) %>% unlist
get_returns_statistics(data.frame(df_1_1, df_1_2)*4, period = 12, plot=T) %>% unlist
